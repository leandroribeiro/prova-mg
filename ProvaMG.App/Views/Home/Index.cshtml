@using ProvaMG.App.Controllers
@{
    Layout = "_Layout1";
    ViewData["Title"] = "Home Page";
}
@model IndexViewModel

<!-- page-intro start-->
<!-- ================ -->
<div class="page-intro">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <ol class="breadcrumb">
                    <li class="active">Home</li>
                </ol>
            </div>
            <div class="col-md-6">
                <ul class="breadcrumb">
                    <li><a href="@Url.Action("Logout", "Conta")">Sair</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- page-intro end -->

<!-- main-container start -->
<!-- ================ -->
<section class="main-container">

    <div class="container">
        <div class="row">

            <!-- main start -->
            <!-- ================ -->
            <div class="main col-md-9">

                <!-- page-title start -->
                @* <h1 id="forms" class="page-title">Home</h1> *@
                
                <div id="unidadesContent"></div>
                <div id="municipiosContent"></div>
                <div id="paginacaoContent"></div>

            </div>
        </div>
    </div>
</section>

@section Styles {
    <link rel="stylesheet" href="~/lib/sweetalert2/sweetalert2.min.css" />
    <link rel="stylesheet" href="~/lib/select2/css/select2.min.css" />

    <style type="text/css">
        .txtedit {
            display: none;
            width: 99%;
            height: 30px;
        }
    </style>
}

@section Scripts {
    <script src="~/lib/sweetalert2/sweetalert2.min.js"></script>
    <script src="~/lib/select2/js/select2.min.js"></script>
    <script src="~/lib/jquery-loading-overlay/loadingoverlay.min.js"></script>

    <script id="combo-template" type="text/x-handlebars-template">
        <h2>{{titulo}}</h2>
        <select class="form-control" id="{{comboId}}" name="{{comboId}}">
            <option value="">Selecione</option>
            {{#each itens }}
                <option value="{{valor}}" {{#selecionado}} selected="selected" {{/selecionado}} >{{texto}}</option>
            {{/each}}
        </select>
    </script>

    <script id="table-template" type="text/x-handlebars-template">
        <h2>{{titulo}}</h2>
        <table class="table table-hover" id="{{tabelaId}}">
            <thead>
            <tr>
                <th>#</th>
                <th>{{cabecalho_nome}}</th>
            </tr>
            </thead>
            <tbody>
                {{#each itens }}
                     <tr>
                         <td>{{codigo}}</td>
                         <td>
                         {{#editavel}}
                             <a href="#" data-id="{{codigo}}">{{nome}}</a>
                             <input type="text" class="txtedit" value="{{nome}}" id="txtedit_{{codigo}}" data-id="{{codigo}}" />
                         {{else}}
                             {{nome}}
                         {{/editavel}}
                         </td>
                     </tr>
                {{/each}}
            </tbody>
        </table>
    </script>

    <script id="paginator-template" type="text/x-handlebars-template">
        <nav aria-label="Paginação dos resultados">
            <ul class="pagination justify-content-center">
                <!--<li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>-->
                {{#each paginas as |pagina| }}
                    <li class="page-item {{#if (eq pagina ../paginaAtual)}}active{{/if}}"><a class="page-link" href="#" data-pagina="{{pagina}}">{{pagina}}</a></li>
                {{/each}}
                <!--<li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>-->
            </ul>
        </nav>   
    </script>

    <script type="text/javascript">
        jQuery(function($) {
            'use strict';

            Handlebars.registerHelper('eq', function(a, b) {
                    return a === b;
                });

            var util = {
                gerarPaginas: function(paginaAtual, paginaFinal) {
                    var min = 1;
                    var max = paginaFinal;

                    var arr = [];
                    for (let i = min; i <= max; i += 1) {
                        arr.push(i);
                    }

                    return arr;
                },

                gerarPaginasComLimite: function(paginaAtual, paginaFinal, limite) {
                    var min = paginaAtual -limite;
                    while(min <= 0){
                        min++;
                    }
                    var max = paginaAtual +limite;
                    while(max > paginaFinal){
                        max--;
                    }
                    var arr = [];
                    for (let i = min; i <= max; i += 1) {
                        arr.push(i);
                    }

                    return arr;
                },
                
                tratarError: function(jqxhr, textStatus, error) {
                    var err = textStatus + ", " + error;
                    
                    console.error('Request Failed: ' + err );
                    
                    Swal.fire({
                        position: 'top',
                        icon: 'error',
                        title: 'Ocorreu um erro!',
                        showConfirmButton: false,
                        timer: 6000,
                        timerProgressBar: true
                    });
                }
            };

            var service = {
                obterUnidades: function() {
                    return $.getJSON('@Url.Action("ObterUnidades")');
                    
                },
                obterMunicipios: function(uf, pagina) {
                    if (uf != null && uf !== '') {
                        return $.getJSON('@Url.Action("ObterMunicipiosPor")', { uf: uf, pagina: pagina });
                    }
                    return false;
                },

                editar: function(municipioCodigo, municipioNovoNome) {
                    return $.post('@Url.Action("AlterarNomeMunicipio")', { codigo: municipioCodigo, novoNome: municipioNovoNome });
                }
            };

            var App = {
                init: function () {
                    this.unidadesTemplate = Handlebars.compile($("#combo-template").html());
                    this.municipiosTemplate = Handlebars.compile($("#table-template").html());
                    this.paginacaoTemplate = Handlebars.compile($("#paginator-template").html());

                    this.bindEvents();
                    this.render();
                },

                bindEvents: function() {
                },

                render: function () {
                    jQuery.LoadingOverlay("show");
                    
                    this.renderUnidades();
                },

                renderUnidades : function() {
                        var _content = $("#unidadesContent");
                        
                        service.obterUnidades()
                            .done(function(data) {
                                var unidades = $.map(data, function(item) {
                                        return { valor: item, texto: item }
                                    });
        
                                _content.html(App.unidadesTemplate({
                                    titulo: 'Unidades',
                                    comboId: 'unidades',
                                    itens: unidades
                                }));
                                
                                _content.find('#unidades').select2({
                                    placeholder: "Selecione um estado",
                                    //dropdownAutoWidth: true
                                    width: '30%'
                                });
        
                                _content.on("change", "select", function(e) {
                                        e.preventDefault();
                                        App.carregarMunicipios($(this).val());
                                    }
                                );
                                
                            })
                            .fail(util.tratarError)
                            .always(function() {
                                jQuery.LoadingOverlay("hide");
                            });

                },

                editarMunicipio: function(elem) {
                    
                    var municipioCodigo = elem.attr('data-id');
                    var municipioNovoNome = elem.val();

                    // TODO Waiting?
                    elem.hide();

                    elem.prev('a').show();
                    elem.prev('a').text(municipioNovoNome);

                    service.editar(municipioCodigo, municipioNovoNome)
                        .done(function (data) {
                            if (data != null && !jQuery.isEmptyObject(data)) {
                                //TODO
                            }
                            
                            const Toast = Swal.mixin({
                              toast: true,
                              position: 'top',
                              showConfirmButton: false,
                              timer: 3000,
                              timerProgressBar: true
                            })
    
                            Toast.fire({
                                icon: 'success',
                                title: '<h4>Alteração realizada com sucesso!</h4>'
                            });
                                    
                        })
                        .fail(util.tratarError);
                },
                
                renderMunicipios: function(data){
                    if (data != null && !jQuery.isEmptyObject(data)) {

                        var _content = $("#municipiosContent");

                        _content.html('');

                        var municipios = $.map(data.results,
                            function(item) {
                                return {
                                    codigo: item.codigo,
                                    nome: item.nome,
                                    editavel: item.editavel
                                }
                            });

                        var municipiosData = {
                            titulo: 'Municípios',
                            tabelaId: 'municipios',
                            cabecalho_nome: "Nome",
                            itens: municipios,
                            
                        };

                        _content.html(App.municipiosTemplate(municipiosData));

                        var paginacaoData = { 
                            paginas: util.gerarPaginas(data.currentPage, data.pageCount),
                            paginaAtual:  data.currentPage
                        };

                        App.renderPaginacao(paginacaoData);

                        jQuery.LoadingOverlay("hide");

                        _content.on("click", "table tbody a", function(event) {
                                event.stopImmediatePropagation();

                                var elem = $(this);
                                elem.next('.txtedit').show().focus();
                                elem.hide();

                            });

                        _content.on("keypress", "table tbody input.txtedit", function(event) {
                            event.stopImmediatePropagation();

                            // PRESS ENTER
                            if ( event.which == 13 ) {
                                event.preventDefault();
                                App.editarMunicipio($(this));
                            }

                        });

                    }                    

                },

                renderPaginacao: function(data){
                    var _content = $("#paginacaoContent");

                    _content.html('');

                    _content.html(App.paginacaoTemplate(data));
                    
                    _content.on("click","nav ul li.page-item a", function(event) {
                            event.stopImmediatePropagation();

                            var elem = $(this);
                            var indicePagina = elem.data('pagina');

                            App.paginar(indicePagina);

                            return false;
                        });
                },

                carregarMunicipios: function(unidadeFederativa, indice) {
                    jQuery.LoadingOverlay("show");

                    if (indice === undefined || indice === null || indice === ''){
                        indice = 1;
                    }
                    
                    service.obterMunicipios(unidadeFederativa, indice)
                        .done(this.renderMunicipios)
                        .fail(util.tratarError)
                        .always(function() {
                            jQuery.LoadingOverlay("hide");
                        });
                },

                paginar: function(indice) {
                    var unidadeFederativa = $("#unidades").val();
                    
                    this.carregarMunicipios(unidadeFederativa, indice);
                }

            } // App

            App.init();

        });

    </script>
}